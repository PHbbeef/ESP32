#include <Arduino.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <IRremoteESP8266.h>
#include <IRsend.h>

int datapin = 23;  //数据输出引脚
int status_air = 3; //开关状态
int khz = 38; //红外频率

//开
uint16_t ACon[357] = {3044, 3058,  3066, 4432,  552, 1688,  556, 580,  556, 1660,  584, 550,  554, 580,  554, 1690,  554, 1662,  584, 552,  550, 582,  554, 1690,  554, 552,  584, 550,  552, 1692,  552, 1692,  554, 552,  584, 552,  554, 1690,  552, 1690,  554, 554,  582, 552,  554, 582,  554, 554,  582, 550,  554, 580,  554, 554,  580, 554,  582, 552,  552, 582,  552, 556,  584, 550,  552, 582,  556, 552,  582, 552,  552, 1690,  554, 582,  550, 556,  584, 550,  554, 582,  552, 558,  582, 552,  532, 1714,  550, 582,  554, 1664,  584, 552,  552, 582,  552, 554,  584, 550,  580, 554,  554, 582,  530, 574,  582, 552,  532, 602,  556, 552,  584, 550,  534, 602,  552, 554,  586, 550,  582, 552,  554, 1690,  554, 552,  586, 550,  552, 582,  554, 552,  584, 550,  586, 550,  554, 578,  556, 552,  584, 550,  556, 580,  554, 552,  584, 550,  556, 580,  554, 552,  582, 552,  558, 578,  556, 580,  556, 550,  582, 554,  554, 580,  554, 552,  584, 552,  554, 580,  554, 554,  582, 550,  554, 580,  554, 554,  582, 552,  582, 552,  554, 580,  554, 552,  584, 552,  554, 580,  552, 558,  582, 550,  554, 582,  552, 552,  582, 552,  554, 582,  552, 582,  552, 554,  580, 554,  554, 1688,  554, 554,  580, 1664,  582, 1664,  552, 582,  552, 1688,  552, 1666,  576, 558,  552, 1690,  552, 1694,  552, 1692,  550, 1666,  578, 556,  550, 1692,  552, 1692,  548, 558,  576, 1668,  574, 1668,  548, 1714,  530, 606,  526, 580,  554, 580,  528, 606,  526, 580,  556, 578,  526, 608,  526, 582,  552, 582,  554, 582,  524, 610,  524, 584,  550, 582,  526, 608,  526, 584,  550, 586,  522, 612,  522, 586,  548, 588,  520, 614,  518, 618,  516, 592,  542, 594,  514, 618,  516, 592,  542, 594,  514, 618,  516, 592,  544, 592,  514, 620,  516, 592,  542, 592,  542, 594,  512, 620,  516, 614,  520, 592,  514, 642,  494, 616,  516, 616,  492, 642,  492, 616,  520, 614,  518, 616,  492, 644,  492, 614,  518, 616,  492, 642,  490, 616,  518, 1724,  520, 614,  492, 1754,  490, 1726,  516, 616,  518, 1728,  488, 1752,  492, 1726,  492};  // HAIER_AC176
//关
uint16_t ACoff[357] = {3046, 3062,  3064, 4434,  554, 1692,  552, 580,  554, 1662,  584, 550,  556, 582,  552, 1690,  554, 1662,  584, 550,  556, 578,  554, 1690,  554, 554,  584, 548,  558, 580,  556, 552,  584, 550,  556, 580,  554, 1690,  554, 1662,  584, 550,  554, 580,  556, 552,  586, 550,  556, 580,  556, 580,  554, 552,  584, 552,  554, 580,  554, 554,  582, 552,  556, 576,  556, 554,  584, 550,  556, 580,  554, 580,  554, 556,  584, 550,  556, 578,  556, 554,  584, 550,  554, 580,  554, 1690,  554, 554,  584, 1660,  556, 580,  556, 552,  582, 554,  552, 582,  554, 582,  556, 552,  582, 552,  554, 580,  554, 554,  582, 552,  556, 584,  550, 554,  582, 552,  554, 580,  554, 582,  552, 1664,  584, 550,  556, 582,  554, 552,  582, 552,  554, 580,  554, 556,  584, 550,  582, 554,  554, 580,  554, 554,  584, 550,  552, 580,  536, 574,  584, 552,  556, 580,  554, 556,  582, 554,  552, 582,  552, 582,  554, 554,  584, 552,  554, 584,  552, 554,  586, 548,  556, 580,  552, 554,  582, 552,  554, 580,  554, 580,  554, 554,  580, 554,  556, 578,  556, 554,  582, 550,  556, 578,  554, 554,  584, 550,  554, 582,  554, 554,  584, 552,  582, 552,  554, 582,  554, 1662,  582, 552,  554, 1692,  552, 582,  552, 1666,  582, 1658,  584, 552,  558, 1686,  554, 556,  582, 1660,  582, 1662,  554, 1690,  554, 580,  554, 1664,  578, 1666,  580, 556,  552, 1690,  554, 1690,  554, 1664,  578, 556,  552, 582,  554, 554,  580, 556,  578, 556,  552, 582,  552, 558,  576, 556,  550, 584,  550, 560,  576, 558,  550, 584,  550, 560,  574, 562,  546, 606,  530, 604,  530, 580,  552, 582,  528, 606,  528, 580,  552, 582,  526, 610,  526, 582,  552, 582,  526, 608,  524, 610,  526, 582,  556, 580,  526, 608,  526, 584,  548, 588,  520, 616,  520, 588,  546, 588,  516, 618,  520, 590,  540, 594,  542, 592,  516, 622,  514, 592,  542, 592,  516, 620,  514, 592,  544, 592,  514, 620,  516, 592,  542, 596,  514, 644,  490, 1754,  492, 616,  516, 1726,  518, 1724,  492, 644,  492, 1752,  492, 1728,  516, 1726,  490};  // HAIER_AC176



const char * ssid = "A";
const char * password = "1234567890";

String url = "http://server.drlihui.eu.org:80/apiAir";
String url_console = "";  //接收红外指令

void wifi();
void http();
void on();
void off();

void setup(){
  pinMode(datapin,OUTPUT);

  Serial.begin(9600);

  wifi();
}


void loop(){

  if(status_air == 0){
    off();
  }
  if(status_air == 1){
    on();
  }


  http();
}


void wifi(){
  WiFi.begin(ssid,password);

  while (WiFi.status() != WL_CONNECTED){
    Serial.print("连接WiFi...");
    delay(10000);
    if(WiFi.status() != WL_CONNECTED){
      Serial.print("连接超时");
      Serial.print("重新连接wifi");
      wifi();
    }
    else{
      Serial.print("WiFi已连接");
    }
  }
}

void http(){
  HTTPClient http;  //创建对象http
  http.begin(url);
  int http_code = http.GET();
  Serial.print("请求状态码："+ http_code);

  //api获取错误
  if(http_code != 200){
     status_air = 3;	//这里如果获取失败内容会为空，所以这里设置状态3
     delay(5000);
     loop();
  }
  //获取响应正文
  String response = http.getString();
  // Serial.print(response);
  http.end(); //关闭http请求


  DynamicJsonDocument doc(1024);  //创建对象
  deserializeJson(doc,response);  //解析JSON数据
  int stauts = doc["status"].as<int>(); //获取解析的JSON数据值，转换成整数
  status_air = stauts;

  delay(2000);
}

void httppost(){
  HTTPClient http_post;
  http_post.begin(url);

  //这里POST转换字符串形式
  String status = String(status_air); 
  int http_postcode = http_post.POST(status); //发送请求

  if (http_postcode != 200){
    delay(2000);
    loop();
  }
}

//心跳检测
void heartbeat(){

}

void on(){
  IRsend irsend(datapin);
  irsend.begin(); //初始化红外发射

  irsend.sendRaw(ACon, sizeof(ACon) / sizeof(ACon[0]), khz); //发射红外
  delay(2000);
  status_air = 3;
  httppost();
}

void off(){
  IRsend irsend(datapin);
  irsend.begin(); //初始化红外发射

  irsend.sendRaw(ACoff, sizeof(ACoff) / sizeof(ACoff[0]), khz); //发射红外
  delay(2000);
  status_air = 3;
  httppost();
}